function e(e,t="USD"){return isNaN(e)||"number"!=typeof e?"N/A":e.toLocaleString("en-US",{style:"currency",currency:t,minimumFractionDigits:0,maximumFractionDigits:0})}function t(e){const t=document.getElementById("annualPreFireTabContent"),n=document.getElementById("monthlyPreFireTabContent"),a=document.getElementById("postFireTabContent"),o=document.getElementById("annualPreFireTabButton"),s=document.getElementById("monthlyPreFireTabButton"),r=document.getElementById("postFireTabButton");[t,n,a].forEach((e=>{e&&e.classList.add("hidden")})),[o,s,r].forEach((e=>{e&&e.classList.remove("active")})),"annualPreFire"===e?(t&&t.classList.remove("hidden"),o&&o.classList.add("active")):"monthlyPreFire"===e?(n&&n.classList.remove("hidden"),s&&s.classList.add("active")):"postFire"===e&&(a&&a.classList.remove("hidden"),r&&r.classList.add("active"))}function n(e,t=[]){const n=document.getElementById("fireMode"),a=n?n.value:"normal";let o=65;if("coast"===a){const e=document.getElementById("coastTargetAge");e&&e.value&&(o=parseInt(e.value))}const{currentAge:s,currentSavings:r,yearlySavingsContribution:l,yearlyExpensesInRetirement:i,withdrawalRate:d,preFireReturn:c,expectedInflationRate:u,monthlyIncomeAfterFIRE:m,numMonthlyRows:g}=e,y=d/100,h=c/100,p=u/100,v=12*m,f=Math.max(0,i-v);if(f>0&&y<=0)return{error:"Withdrawal rate must be > 0 if savings are needed to cover expenses."};const b=f<=0?0:f/y,x=Math.pow((1+h)/(1+p),1/12)-1;let E=r,I=0;const R=[],k=[],F=[];let B=null,M=null,A=null;if("coast"===a){let e=s,n=0,a=!1;for(;e<o&&!a&&n<840;){let i=n,d=r,c=0;for(let e=0;e<i;e++){const n=s+e/12;let a=0;Array.isArray(t)&&t.forEach((e=>{if(n>=e.startAge&&n<e.endAge+1/12){let t="income"===e.type?e.amount:-e.amount;e.startAge!==e.endAge&&(t/=12),a+=t}})),d=d*(1+x)+l/12+a,c+=l/12}let u=d;for(let e=0;e<12*(o-(s+i/12));e++){const n=s+i/12+e/12;let a=0;Array.isArray(t)&&t.forEach((e=>{if(n>=e.startAge&&n<e.endAge+1/12){let t="income"===e.type?e.amount:-e.amount;e.startAge!==e.endAge&&(t/=12),a+=t}})),u=u*(1+x)+a}if(u>=b){B=s+i/12,M=d,A=c,a=!0;const e=Math.round(i);let n=r,o={contributions:0,growth:0,startOfYearSavings:r,events:0};for(let a=1;a<=e;a++){const r=s+a/12,i=n,d=n*x,c=l/12;let u=0;Array.isArray(t)&&t.forEach((e=>{if(r>=e.startAge&&r<e.endAge+1/12){let t="income"===e.type?e.amount:-e.amount;e.startAge!==e.endAge&&(t/=12),u+=t}})),n+=d+c+u,o.contributions+=c,o.growth+=d,o.events+=u,a<=g&&k.push({month:a,startingBalanceForMonth:i,currentMonthlySavingsContribution:c,growthThisMonth:d,eventCashFlow:u,accumulatedSavings:n,currentMonthAge:r}),a%12!=0&&a!==e||(R.push({year:Math.ceil(a/12),age:s+a/12,startOfYearSavings:o.startOfYearSavings,contributions:o.contributions,growth:o.growth,events:o.events,endOfYearSavings:n}),o={contributions:0,growth:0,startOfYearSavings:n,events:0})}break}n++,e=s+n/12}}let w=null;if("normal"===a||"coast"===a&&!B){let n=r>=b&&b>=0;0===b&&r>=0&&(n=!0);let a={contributions:0,growth:0,startOfYearSavings:r,events:0},o=0;const d=new Date;let c=null,u=null,m=null;if(n){o=0;let t=E;const n=s+5;for(let a=1;;a++){if(s+a/12>n)break;new Date(d).setMonth(d.getMonth()+a);t=t*(1+(Math.pow((1+e.preFireReturn/100)/(1+e.expectedInflationRate/100),1/12)-1))+l/12-i/12;if(t<=0)break}}else{for(let e=1;e<=840;e++){const r=s+e/12,i=l/12,d=E,y=E*x;let h=0;if(Array.isArray(t)&&t.forEach((e=>{if(r>=e.startAge&&r<e.endAge+1/12){let t="income"===e.type?e.amount:-e.amount;e.startAge!==e.endAge&&(t/=12),h+=t}})),E+=y+i+h,I+=i,a.contributions+=i,a.growth+=y,a.events+=h,e<=g&&k.push({month:e,startingBalanceForMonth:d,currentMonthlySavingsContribution:i,growthThisMonth:y,eventCashFlow:h,accumulatedSavings:E,currentMonthAge:r}),e%12==0&&(R.push({year:e/12,age:s+e/12,startOfYearSavings:a.startOfYearSavings,contributions:a.contributions,growth:a.growth,events:a.events,endOfYearSavings:E}),a={contributions:0,growth:0,startOfYearSavings:E,events:0}),E>=b){o=e,n=!0,c=e,u=r,m=E,e%12!=0&&R.push({year:Math.ceil(e/12),age:s+e/12,startOfYearSavings:a.startOfYearSavings,contributions:a.contributions,growth:a.growth,events:a.events,endOfYearSavings:E});break}}if(n&&null!==c&&null!==u&&null!==m){let t=m;const n=u+5;for(let a=1;;a++){if(u+a/12>n)break;new Date(d).setMonth(d.getMonth()+c-1+a);t=t*(1+(Math.pow((1+e.preFireReturn/100)/(1+e.expectedInflationRate/100),1/12)-1))+l/12-i/12;if(t<=0)break}}}n||(o=840),w={fireNumber:b,timeToFIREMonths:o,ageAtFIRE:s+o/12,savingsAtFIRE:E,totalContributionsToFIRE:I,fireReached:n,annualProjectionData:R,monthlyProjectionData:k,earlyRetirementPlotData:F}}return"coast"===a&&B?{fireNumber:b,coastFIREAge:B,coastFIREAccum:M,coastFIREContribs:A,coastTargetAge:o,mode:"coast",fireReached:!0,annualProjectionData:R,monthlyProjectionData:k,earlyRetirementPlotData:[]}:w||{error:"Could not find a solution for this mode."}}const a=document.getElementById("feedbackButton"),o=document.getElementById("feedbackModal"),s=document.getElementById("closeFeedbackModal"),r=document.getElementById("feedbackForm"),l=document.getElementById("feedbackThanks");a&&a.addEventListener("click",(()=>{o.classList.remove("hidden"),r.classList.remove("hidden"),l.classList.add("hidden"),r.reset()})),s&&s.addEventListener("click",(()=>{o.classList.add("hidden")})),window.addEventListener("click",(e=>{e.target==o&&o.classList.add("hidden")})),r&&r.addEventListener("submit",(function(e){e.preventDefault();const t=document.getElementById("feedbackSubmitButton");t.disabled=!0,t.textContent="Submitting...";const n=new FormData(this);fetch(this.action,{method:"POST",body:n,headers:{Accept:"application/json"}}).then((e=>{e.ok?(r.classList.add("hidden"),l.classList.remove("hidden")):e.json().then((e=>{Object.hasOwn(e,"errors")?alert(e.errors.map((e=>e.message)).join(", ")):alert("Oops! There was a problem submitting your form")}))})).catch((e=>{alert("Oops! There was a problem submitting your form")})).finally((()=>{t.disabled=!1,t.textContent="Submit"}))}));let i=null,d=null,c=null,u=0,m=0,g=[],y=[],h=null;const p=document.getElementById("currentYear"),v=document.getElementById("currentAge"),f=document.getElementById("currentSavings"),b=document.getElementById("grossAnnualIncome"),x=document.getElementById("yearlySavingsContribution"),E=document.getElementById("yearlyExpensesInRetirement"),I=document.getElementById("withdrawalRate"),R=document.getElementById("preFireReturn"),k=document.getElementById("postFireReturn"),F=document.getElementById("expectedInflationRate"),B=document.getElementById("monthlyIncomeAfterFIRE"),M=document.getElementById("currency"),A=document.getElementById("calculateButton"),w=document.getElementById("resetButton"),C=document.getElementById("printSummaryButton"),S=document.getElementById("exportDataButton"),L=document.getElementById("resultsSection"),$=document.getElementById("errorMessage"),T=(document.getElementById("postFireWarningMessage"),document.getElementById("fireNumberResult")),P=document.getElementById("timeToFIREResult"),N=document.getElementById("ageAtFIREResult"),Y=document.getElementById("fiDateResult"),V=document.getElementById("savingsRateResult"),D=document.getElementById("expensesCoveredResult"),O=document.getElementById("savingsAtFIREResult"),j=document.getElementById("totalContributionsResult"),U=document.getElementById("totalGrowthResult"),H=document.getElementById("annualProjectionTableBody"),W=document.getElementById("monthlyProjectionTableBody"),z=document.getElementById("detailedMonthsCount"),q=document.getElementById("numMonthlyRows"),G=document.getElementById("postFireProjectionTableBody"),J=document.getElementById("oneMoreYearSection"),X=document.getElementById("extraWorkingYears"),K=document.getElementById("omyYearlySavingsContribution"),Q=document.getElementById("runOneMoreYearButton"),Z=document.getElementById("oneMoreYearResultsContainer"),_=document.getElementById("oneMoreYearErrorMessage"),ee=document.getElementById("extraYearsDisplay"),te=document.getElementById("omyPortfolioValue"),ne=document.getElementById("omyRetirementAge"),ae=document.getElementById("omyIncreasedSpending"),oe=document.getElementById("omyFundsLastUntil"),se=document.getElementById("earlyRetirementIncomeSection"),re=document.getElementById("earlyRetirementPlotContainer"),le=document.getElementById("compStartDateMonth"),ie=document.getElementById("compStartDateYear"),de=document.getElementById("compSavings1"),ce=document.getElementById("compStartSavings1"),ue=document.getElementById("compSavings2"),me=document.getElementById("compStartSavings2"),ge=document.getElementById("runEarlyRetirementPlotButton"),ye=document.getElementById("retirementSimulationSection"),he=document.querySelectorAll('input[name="simType"]'),pe=document.getElementById("monteCarloParams"),ve=document.getElementById("historicalParams"),fe=document.getElementById("simPortfolioValue"),be=document.getElementById("simYearlyExpenses"),xe=document.getElementById("simRetirementAge"),Ee=document.getElementById("simReturn"),Ie=document.getElementById("simVolatility"),Re=document.getElementById("simCount"),ke=document.getElementById("runSimulationButton"),Fe=document.getElementById("simulationPlotContainer"),Be=document.getElementById("simulationResultsContainer"),Me=document.getElementById("simSuccessRate"),Ae=document.getElementById("simMedian"),we=document.getElementById("sim10thPercentile"),Ce=document.getElementById("sim90thPercentile"),Se=document.getElementById("simFlexYears"),Le=document.getElementById("simulationWarning"),$e=document.getElementById("simulationErrorMessage"),Te=document.querySelectorAll(".preset-button"),Pe=document.getElementById("flexThreshold"),Ne=document.getElementById("flexReduction"),Ye=document.getElementById("stockAllocation"),Ve=document.getElementById("stockAllocationValue"),De=document.getElementById("bondAllocationValue"),Oe=document.getElementById("exportModal"),je=document.getElementById("closeExportModal"),Ue=document.getElementById("exportDataTextArea"),He=document.getElementById("copyExportDataButton"),We=document.getElementById("fireMode");function ze(e,t=!1,n=!1){const a=[];n?((isNaN(e.extraWorkingYears)||e.extraWorkingYears<0||e.extraWorkingYears>20)&&a.push("Extra Working Years: Must be between 0 and 20."),e.baseFireReached||a.push("Main projection must be calculated first."),null!==e.omyYearlySavingsContribution&&(isNaN(e.omyYearlySavingsContribution)||e.omyYearlySavingsContribution<0)&&a.push("OMY Yearly Savings must be a non-negative number.")):t?((isNaN(e.simRetirementAge)||e.simRetirementAge<=0||e.simRetirementAge>120)&&a.push("Sim Retirement Age: Must be between 1-120."),(isNaN(e.simPortfolioValue)||e.simPortfolioValue<0)&&a.push("Retirement Portfolio must be a non-negative number."),(isNaN(e.simYearlyExpenses)||e.simYearlyExpenses<0)&&a.push("Yearly Expenses must be a non-negative number."),"monteCarlo"===e.simType?((isNaN(e.simVolatility)||e.simVolatility<0||e.simVolatility>100)&&a.push("Market Volatility: Must be between 0-100."),(isNaN(e.simReturn)||e.simReturn<-50||e.simReturn>50)&&a.push("Avg. Annual Return: Must be between -50 and 50."),(isNaN(e.simCount)||e.simCount<100||e.simCount>1e4)&&a.push("Number of Simulations: Must be between 100 and 10,000.")):(isNaN(e.stockAllocation)||e.stockAllocation<0||e.stockAllocation>100)&&a.push("Stock Allocation must be between 0 and 100."),(isNaN(e.flexThreshold)||e.flexThreshold<0||e.flexThreshold>100)&&a.push("Flex Threshold: Must be between 0-100."),(isNaN(e.flexReduction)||e.flexReduction<0||e.flexReduction>100)&&a.push("Spending Reduction: Must be between 0-100.")):((isNaN(e.currentAge)||e.currentAge<=0||e.currentAge>100)&&a.push("Current Age: Must be between 1 and 100."),(isNaN(e.currentSavings)||e.currentSavings<0)&&a.push("Current Savings: Must be a non-negative number."),(isNaN(e.yearlySavingsContribution)||e.yearlySavingsContribution<0)&&a.push("Yearly Savings Contribution: Must be a non-negative number."),e.grossAnnualIncome>0&&e.yearlySavingsContribution>e.grossAnnualIncome&&e.yearlySavingsContribution>0&&a.push("Yearly Savings Contribution cannot exceed Gross Annual Income."),(isNaN(e.yearlyExpensesInRetirement)||e.yearlyExpensesInRetirement<=0)&&a.push("Yearly Expenses in Retirement: Must be a positive number."),(isNaN(e.withdrawalRate)||e.withdrawalRate<=0||e.withdrawalRate>20)&&a.push("Withdrawal Rate: Must be between 0.1 and 20."),(isNaN(e.preFireReturn)||e.preFireReturn<-50||e.preFireReturn>50)&&a.push("Pre-FIRE Return: Must be between -50 and 50."),(isNaN(e.postFireReturn)||e.postFireReturn<-50||e.postFireReturn>50)&&a.push("Post-FIRE Return: Must be between -50 and 50."),(isNaN(e.expectedInflationRate)||e.expectedInflationRate<-10||e.expectedInflationRate>20)&&a.push("Inflation Rate: Must be between -10 and 20."));let o=n?_:t?$e:$;return a.length>0?(o.innerHTML="Please correct the following: <br>"+a.join("<br>"),o.classList.remove("hidden"),!1):(o.classList.add("hidden"),!0)}function qe(){return{currentAge:parseFloat(v.value),currentSavings:parseFloat(f.value),grossAnnualIncome:parseFloat(b.value),yearlySavingsContribution:parseFloat(x.value),yearlyExpensesInRetirement:parseFloat(E.value),withdrawalRate:parseFloat(I.value),preFireReturn:parseFloat(R.value),postFireReturn:parseFloat(k.value),expectedInflationRate:parseFloat(F.value),monthlyIncomeAfterFIRE:parseFloat(B.value),numMonthlyRows:parseInt(q.value),currency:M.value}}function Ge(){const t=qe();if(!ze(t))return;const a=n(t,g);if(d=a,a.error)return $.textContent=a.error,$.classList.remove("hidden"),void L.classList.add("hidden");u=a.ageAtFIRE||("coast"===a.mode?a.coastFIREAge:0),m=a.savingsAtFIRE||("coast"===a.mode?a.coastFIREAccum:0),y=a.earlyRetirementPlotData||[],function(t,n){const{fireNumber:a,timeToFIREMonths:o,ageAtFIRE:s,savingsAtFIRE:r,totalContributionsToFIRE:l,fireReached:i,mode:d,coastFIREAge:c,coastFIREAccum:u,coastFIREContribs:m,coastTargetAge:g}=t,{currency:y,currentAge:h,grossAnnualIncome:p,yearlySavingsContribution:v,yearlyExpensesInRetirement:f}=n,b=70,x=document.getElementById("coastNumberCard"),E=document.getElementById("coastNumberResult");if("coast"===d&&c){if(T.textContent=e(a,y),P.textContent=`${(c-h).toFixed(1)} Yrs to Coast`,N.textContent=`Coast at ${c.toFixed(1)}`,void 0!==g&&g>h){const e=g-h,t=new Date;t.setFullYear(t.getFullYear()+Math.floor(e)),t.setMonth(t.getMonth()+Math.round(e%1*12)),Y.textContent=t.toLocaleDateString("en-US",{year:"numeric",month:"long"})}else Y.textContent="N/A";V.textContent=p>0?(v/p*100).toFixed(1)+"%":"N/A",D.textContent=(n.currentSavings/f).toFixed(1)+" Years",j.textContent=e(m,y),U.textContent=e(u-n.currentSavings-m,y),O.textContent=e(u,y),x&&E&&(x.classList.remove("hidden"),E.textContent=e(u,y)),J.classList.add("hidden"),ye.classList.add("hidden"),se.classList.add("hidden")}else{T.textContent=e(a,y),P.textContent=i?`${Math.floor(o/12)} Yrs, ${o%12} Mos`:`> ${b} Yrs`;const t=Math.floor(s),d=Math.round(s%1*12);if(N.textContent=i?`${t}y ${d}m`:`> ${h+b}`,i){const e=new Date;e.setMonth(e.getMonth()+o),Y.textContent=e.toLocaleDateString("en-US",{year:"numeric",month:"long"})}else Y.textContent="Not Reached";const c=p>0&&v>=0?v/p*100:0;V.textContent=c.toFixed(1)+"%";const u=f>0&&n.currentSavings>=0?n.currentSavings/f:0;D.textContent=u.toFixed(1)+" Years",j.textContent=e(l,y);const m=r-n.currentSavings-l;U.textContent=e(m,y)+(i?"":" (proj.)"),O.textContent=e(r,y),J.classList.remove("hidden"),ye.classList.remove("hidden"),x&&x.classList.add("hidden"),fe.value=Math.round(r),xe.value=Math.round(s),be.value=n.yearlyExpensesInRetirement,Ee.value=n.postFireReturn}L.classList.remove("hidden"),C.classList.remove("hidden"),S.classList.remove("hidden");const I=document.getElementById("maxYearsMessage");I&&(I.classList.toggle("hidden",i),i||(I.textContent=`FIRE goal not reached within ${b} years.`))}(a,t),function(t,n){const{annualProjectionData:a,monthlyProjectionData:o,fireReached:s,savingsAtFIRE:r,ageAtFIRE:l}=t,{currency:i,postFireReturn:d,expectedInflationRate:c,yearlyExpensesInRetirement:u,monthlyIncomeAfterFIRE:m,numMonthlyRows:g}=n;H.innerHTML="",a&&a.forEach((t=>{H.innerHTML+=`<tr><td>${t.year}</td><td>${Math.floor(t.age)}</td><td>${e(t.startOfYearSavings,i)}</td><td>${e(t.contributions,i)}</td><td>${e(t.growth,i)}</td><td>${e(t.events||0,i)}</td><td>${e(t.endOfYearSavings,i)}</td></tr>`}));W.innerHTML="",z&&(z.textContent=g);o&&o.forEach((t=>{const n=new Date;n.setMonth(n.getMonth()+t.month-1);const a=t.currentMonthAge;W.innerHTML+=`<tr><td>${t.month}</td><td>${n.toLocaleString("default",{month:"short"})} ${n.getFullYear()}</td><td>${a.toFixed(1)}</td><td>${e(t.startingBalanceForMonth,i)}</td><td>${e(t.currentMonthlySavingsContribution,i)}</td><td>${e(t.growthThisMonth,i)}</td><td>${e(t.eventCashFlow||0,i)}</td><td>${e(t.accumulatedSavings,i)}</td></tr>`}));const y=document.getElementById("postFireTabButton");G.innerHTML="",y&&(y.disabled=!s);if(s&&l){let t=r;const n=(1+d/100)/(1+c/100)-1,a=Math.max(0,u-12*m);let o=!1;for(let s=0;s<95-l;s++){const r=Math.floor(l)+s;if(r>=95)break;const d=t,c=d*n;if(t+=c-a,t<=0&&a>0&&(t=0,o=!0),G.innerHTML+=`<tr><td>${s+1}</td><td>${r}</td><td>${e(d,i)}</td><td>${e(c,i)}</td><td>${e(a,i)}</td><td>${e(12*m,i)}</td><td>${e(t,i)}</td></tr>`,o)break}}else if("coast"===t.mode&&t.fireReached){let n=t.fireNumber;const a=(1+d/100)/(1+c/100)-1,o=Math.max(0,u-12*m);let s=!1;for(let r=0;r<95-t.coastTargetAge;r++){const l=Math.floor(t.coastTargetAge)+r;if(l>=95)break;const d=n,c=d*a;if(n+=c-o,n<=0&&o>0&&(n=0,s=!0),G.innerHTML+=`<tr><td>${r+1}</td><td>${l}</td><td>${e(d,i)}</td><td>${e(c,i)}</td><td>${e(o,i)}</td><td>${e(12*m,i)}</td><td>${e(n,i)}</td></tr>`,s)break}}}(a,t);const o=function(e,t){if(!e||void 0===e.savingsAtFIRE||void 0===e.ageAtFIRE)return null;return{simType:document.querySelector('input[name="simType"]:checked').value,simPortfolioValue:Math.round(e.savingsAtFIRE),simRetirementAge:Math.round(e.ageAtFIRE),simYearlyExpenses:t.yearlyExpensesInRetirement,simReturn:parseFloat(Ee.value),simVolatility:parseFloat(Ie.value),simCount:parseInt(Re.value),stockAllocation:parseFloat(Ye.value)/100,flexThreshold:parseFloat(Pe.value)/100,flexReduction:parseFloat(Ne.value)/100,currency:t.currency}}(a,t);o&&_e(o,!0),se&&(se.classList.remove("hidden"),de.value=t.yearlySavingsContribution,ce.value="",ue.value="",me.value="",Xe())}function Je(){Z.classList.add("hidden"),_.classList.add("hidden");const t=parseFloat(X.value),n=""===K.value.trim()?null:parseFloat(K.value);if(!ze({extraWorkingYears:t,baseFireReached:d&&d.fireReached,omyYearlySavingsContribution:n},!1,!0))return;const a=null===n||isNaN(n)?parseFloat(x.value):n,{preFireReturn:o,expectedInflationRate:s,postFireReturn:r,yearlyExpensesInRetirement:l,withdrawalRate:c,monthlyIncomeAfterFIRE:g,currency:y}=qe(),h=Math.pow((1+o/100)/(1+s/100),1/12)-1;let p=m;for(let e=0;e<t;e++)p=p*(1+h)**12+a-l;const v=u+t,f=p*(c/100)+12*g,b=f-(m*(c/100)+12*g);let E="> 95";const I=(1+r/100)/(1+s/100)-1,R=Math.max(0,l-12*g);let k=p;for(let e=0;e<96-v;e++){if(k<=0&&R>0){E=(v+e).toFixed(0);break}k=k*(1+I)-R}ee.textContent=t,te.textContent=e(p,y),ne.textContent=v.toFixed(1),ae.innerHTML=`${e(f,y)}<br><span class='text-green-700 text-sm'>(+${e(b,y)} vs. original)</span>`,oe.textContent=E,Z.classList.remove("hidden"),i={extraYears:t,newPortfolioValue:p,newRetirementAge:v,newTotalSpendingPossible:f,deltaSpending:b,fundsLastUntilAge:E}}function Xe(){const t=[],n=parseFloat(v.value),a=parseFloat(f.value),o=parseFloat(I.value)/100,s=parseFloat(R.value)/100,r=parseFloat(F.value)/100,l=12*parseFloat(B.value),i=Math.pow((1+s)/(1+r),1/12)-1,d=new Date(parseInt(ie.value),parseInt(le.value),1),c=M.value;[{savingsEl:de,startSavingsEl:ce,label:null},{savingsEl:ue,startSavingsEl:me,label:null}].forEach(((s,r)=>{const m=s.savingsEl.value.trim();if(""===m||isNaN(parseFloat(m)))return;const g=parseFloat(m);let y,h="";if(0===r)y=a;else{const t=s.startSavingsEl.value.trim();""===t||isNaN(parseFloat(t))?y=a:(y=parseFloat(t),h=` (Start: ${e(y,c)})`)}null===s.label&&(s.label=`Savings ${e(g,c)}/yr`+h);let p=[],v=y;const f=new Date(d),b=v*o+l;p.push({age:n,incomeValue:b/12,capitalValue:v,date:f});for(let e=1;e<12*(u+5-n);e++){const t=n+e/12,a=new Date(d);a.setMonth(d.getMonth()+e);v=v*(1+i)+g/12;const s=v*o+l;if(p.push({age:t,incomeValue:s/12,capitalValue:v,date:a}),t>=u+4.9)break}t.push({label:s.label,values:p})})),0!==t.length?function(t,n=!1){re.innerHTML="";const a=t.flatMap((e=>e.values));if(!a||0===a.length)return;const o=re.getBoundingClientRect(),s=o.width>0?o.width:600,r={top:50,right:n?250:80,bottom:50,left:70},l=s-r.left-r.right,i=400-r.top-r.bottom;if(l<=0)return;const d=d3.select("#earlyRetirementPlotContainer").append("svg").attr("width",l+r.left+r.right).attr("height",i+r.top+r.bottom).append("g").attr("transform",`translate(${r.left},${r.top})`),c=d3.select("body").append("div").attr("class","d3-tooltip"),m=M.value,g=d3.scaleLinear().domain([0,d3.max(a,(e=>e.incomeValue))]).range([i,0]).nice(),y=d3.scaleLinear().domain([0,d3.max(a,(e=>e.capitalValue))]).range([i,0]).nice(),p=d3.scaleLinear().domain(d3.extent(a,(e=>e.age))).range([0,l]);d.append("g").attr("class","grid").call(d3.axisLeft(g).ticks(5).tickSize(-l).tickFormat("")),d.append("g").attr("class","axis").attr("transform",`translate(0,${i})`).call(d3.axisBottom(p).tickFormat(d3.format("d"))),d.append("g").attr("class","axis axis--left").call(d3.axisLeft(g).tickFormat((t=>e(t,m)))),d.append("g").attr("class","axis axis--right").attr("transform",`translate(${l}, 0)`).call(d3.axisRight(y).tickFormat((e=>isNaN(e)?"":0===e?"0":Math.abs(e)>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":Math.abs(e)>=1e3?(e/1e3).toFixed(0)+"k":e.toString())));const v=d3.scaleOrdinal(d3.schemeCategory10);t.forEach(((e,t)=>{const a=d3.line().x((e=>p(e.age))).y((e=>g(e.incomeValue))),o=d3.line().x((e=>p(e.age))).y((e=>y(e.capitalValue)));if(d.append("path").datum(e.values).attr("fill","none").attr("stroke",v(t)).attr("stroke-width",2.5).attr("d",a),d.append("path").datum(e.values).attr("fill","none").attr("stroke",v(t)).style("stroke-dasharray","5,5").attr("stroke-width",2.5).attr("d",o),n){const n=d.append("g").attr("class","legend-item").attr("transform",`translate(${l+20}, ${30*t})`);n.append("rect").attr("width",10).attr("height",10).style("fill",v(t)),n.append("text").attr("x",15).attr("y",9).text(e.label).style("font-size","0.75rem")}}));const f=parseFloat(E.value)/12;f>0&&f<g.domain()[1]&&(d.append("line").attr("x1",0).attr("x2",l).attr("y1",g(f)).attr("y2",g(f)).attr("stroke","#ef4444").attr("stroke-width",2).attr("stroke-dasharray","5,5"),d.append("text").attr("x",l+5).attr("y",g(f)+4).attr("fill","#ef4444").style("font-size","0.7rem").text("Target Income"));u>p.domain()[0]&&u<p.domain()[1]&&(d.append("line").attr("x1",p(u)).attr("x2",p(u)).attr("y1",0).attr("y2",i).attr("stroke","#3b82f6").attr("stroke-width",2).attr("stroke-dasharray","5,5"),d.append("text").attr("transform",`translate(${p(u)}, -10) rotate(-90)`).attr("fill","#3b82f6").style("font-size","0.7rem").style("text-anchor","end").text("FIRE Age"));d.append("text").attr("x",l/2).attr("y",0-r.top/2).attr("class","plot-title").style("fill","#047857").text("Potential Monthly Income & Capital Growth"),d.append("text").attr("class","axis-label").attr("text-anchor","middle").attr("x",l/2).attr("y",i+r.bottom-10).text("Age"),d.append("text").attr("class","axis-label").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",0-r.left+20).attr("x",0-i/2).text("Potential Monthly Income (Solid)"),d.append("text").attr("class","axis-label").attr("text-anchor","middle").attr("transform","rotate(90)").attr("y",0-l-r.right+45).attr("x",i/2).text("Accumulated Capital (Dashed)");const b=d3.bisector((e=>e.age)).left;d.append("rect").attr("width",l).attr("height",i).style("fill","none").style("pointer-events","all").on("mouseover",(()=>c.style("opacity",1))).on("mouseout",(()=>c.style("opacity",0))).on("mousemove",(n=>{const[a]=d3.pointer(n),o=p.invert(a);let s="";const r=M.value;t.forEach(((t,n)=>{const a=b(t.values,o,1),l=t.values[a-1],i=t.values[a],d=i&&o-l.age>i.age-o?i:l;d&&(h=d,s+=`<div style="color: ${v(n)}; text-align: left;">\n                        <strong>${t.label}</strong><br>\n                        Date: ${d.date.toLocaleString("default",{month:"short",year:"numeric"})}<br>\n                        Age: ${d.age.toFixed(1)}<br>\n                        Income: ${e(d.incomeValue,r)}/month<br>\n                        Capital: ${e(d.capitalValue,r)}\n                        </div><hr class="my-1 border-gray-500">`)})),c.html(s).style("left",n.pageX+15+"px").style("top",n.pageY-28+"px")}))}(t,!0):re.innerHTML='<p class="text-center text-gray-500">Please enter at least one savings scenario to plot.</p>'}const Ke=[{year:1928,stocks:.4381,bonds:.0084},{year:1929,stocks:-.083,bonds:.042},{year:1930,stocks:-.249,bonds:.0454},{year:1931,stocks:-.4334,bonds:-.0256},{year:1932,stocks:-.0819,bonds:.0879},{year:1933,stocks:.5399,bonds:.0351},{year:1934,stocks:-.0144,bonds:.0784},{year:1935,stocks:.4767,bonds:.0465},{year:1936,stocks:.3393,bonds:.0526},{year:1937,stocks:-.3503,bonds:.0113},{year:1938,stocks:.3112,bonds:.0436},{year:1939,stocks:-.0041,bonds:.0441},{year:1940,stocks:-.0978,bonds:.054},{year:1941,stocks:-.1159,bonds:.0234},{year:1942,stocks:.2034,bonds:.0267},{year:1943,stocks:.259,bonds:.0249},{year:1944,stocks:.1975,bonds:.0267},{year:1945,stocks:.3644,bonds:.0358},{year:1946,stocks:-.0807,bonds:.0223},{year:1947,stocks:.0571,bonds:.0142},{year:1948,stocks:.055,bonds:.0157},{year:1949,stocks:.1879,bonds:.0396},{year:1950,stocks:.3171,bonds:.0166},{year:1951,stocks:.2402,bonds:-.0016},{year:1952,stocks:.1837,bonds:.021},{year:1953,stocks:-.0099,bonds:.0231},{year:1954,stocks:.5262,bonds:.0505},{year:1955,stocks:.3156,bonds:-.0054},{year:1956,stocks:.0656,bonds:-.0245},{year:1957,stocks:-.1078,bonds:.0531},{year:1958,stocks:.4337,bonds:-.0093},{year:1959,stocks:.1196,bonds:-.0236},{year:1960,stocks:.0047,bonds:.1164},{year:1961,stocks:.2689,bonds:.0286},{year:1962,stocks:-.0873,bonds:.0543},{year:1963,stocks:.228,bonds:.0218},{year:1964,stocks:.1648,bonds:.0343},{year:1965,stocks:.1245,bonds:.0121},{year:1966,stocks:-.1006,bonds:.0366},{year:1967,stocks:.2398,bonds:-.0298},{year:1968,stocks:.1106,bonds:.0335},{year:1969,stocks:-.085,bonds:-.0506},{year:1970,stocks:.0401,bonds:.1213},{year:1971,stocks:.1431,bonds:.0931},{year:1972,stocks:.1898,bonds:.0583},{year:1973,stocks:-.1466,bonds:.0338},{year:1974,stocks:-.2647,bonds:.0441},{year:1975,stocks:.372,bonds:.0919},{year:1976,stocks:.2384,bonds:.1681},{year:1977,stocks:-.0718,bonds:.0299},{year:1978,stocks:.0656,bonds:-.0119},{year:1979,stocks:.1844,bonds:-.011},{year:1980,stocks:.325,bonds:.0271},{year:1981,stocks:-.0491,bonds:.0655},{year:1982,stocks:.2155,bonds:.4035},{year:1983,stocks:.2256,bonds:.0366},{year:1984,stocks:.0627,bonds:.1584},{year:1985,stocks:.3173,bonds:.221},{year:1986,stocks:.1867,bonds:.156},{year:1987,stocks:.0525,bonds:-.027},{year:1988,stocks:.1661,bonds:.0789},{year:1989,stocks:.3169,bonds:.1812},{year:1990,stocks:-.031,bonds:.0617},{year:1991,stocks:.3047,bonds:.1593},{year:1992,stocks:.0762,bonds:.0792},{year:1993,stocks:.1008,bonds:.1366},{year:1994,stocks:.0132,bonds:-.0782},{year:1995,stocks:.3758,bonds:.2348},{year:1996,stocks:.2296,bonds:.0163},{year:1997,stocks:.3336,bonds:.0991},{year:1998,stocks:.2858,bonds:.1321},{year:1999,stocks:.2104,bonds:-.0825},{year:2e3,stocks:-.091,bonds:.1666},{year:2001,stocks:-.1189,bonds:.0558},{year:2002,stocks:-.221,bonds:.1026},{year:2003,stocks:.2868,bonds:.041},{year:2004,stocks:.1088,bonds:.0427},{year:2005,stocks:.0491,bonds:.0296},{year:2006,stocks:.1579,bonds:.0223},{year:2007,stocks:.0549,bonds:.0699},{year:2008,stocks:-.37,bonds:.201},{year:2009,stocks:.2646,bonds:-.1112},{year:2010,stocks:.1506,bonds:.0846},{year:2011,stocks:.0211,bonds:.1604},{year:2012,stocks:.16,bonds:.0297},{year:2013,stocks:.3239,bonds:-.091},{year:2014,stocks:.1369,bonds:.1075},{year:2015,stocks:.0138,bonds:.0131},{year:2016,stocks:.1196,bonds:.0061},{year:2017,stocks:.2183,bonds:.028},{year:2018,stocks:-.0438,bonds:1e-4},{year:2019,stocks:.3149,bonds:.1465},{year:2020,stocks:.184,bonds:.1175},{year:2021,stocks:.2871,bonds:-.045},{year:2022,stocks:-.1811,bonds:-.312},{year:2023,stocks:.2629,bonds:.0405}];let Qe=null;function Ze(){let e,t,n;if(null!==Qe)return e=Qe,Qe=null,e;do{e=2*Math.random()-1,t=2*Math.random()-1,n=e*e+t*t}while(n>=1||0===n);return n=Math.sqrt(-2*Math.log(n)/n),Qe=t*n,e*n}function _e(t,n=!1){t||(t={simType:document.querySelector('input[name="simType"]:checked').value,simPortfolioValue:parseFloat(fe.value),simRetirementAge:parseFloat(xe.value),simYearlyExpenses:parseFloat(be.value),simReturn:parseFloat(Ee.value),simVolatility:parseFloat(Ie.value),simCount:parseInt(Re.value),stockAllocation:parseFloat(Ye.value)/100,flexThreshold:parseFloat(Pe.value)/100,flexReduction:parseFloat(Ne.value)/100,currency:M.value}),ze(t,!0)&&(Le.textContent="Running simulation...",Le.classList.remove("hidden"),setTimeout((()=>{const{simPortfolioValue:n,simRetirementAge:a,simYearlyExpenses:o,flexThreshold:s,flexReduction:r}=t,l=parseFloat(F.value)/100,i=12*parseFloat(B.value),d=Math.max(0,o-i),u=d*(1-r);let m=[],g=[],y=[];if("monteCarlo"===t.simType){const{simReturn:e,simVolatility:o,simCount:r}=t,i=e/100,c=o/100;for(let e=0;e<r;e++){const{path:e,finalValue:t,flexYears:o}=et((()=>Ze()*c+i),n,a,d,u,s,l);m.push(e),g.push(t),y.push(o)}}else{const{stockAllocation:e}=t,o=1-e,r=95-a;if(r<1)return $e.textContent="Retirement age is too high for historical simulation (must be less than 95).",$e.classList.remove("hidden"),void Le.classList.add("hidden");for(let t=0;t<=Ke.length-r;t++){const i=Ke.slice(t,t+r),{path:c,finalValue:h,flexYears:p}=et((t=>i[t].stocks*e+i[t].bonds*o),n,a,d,u,s,l);m.push(c),g.push(h),y.push(p)}}if(0===m.length)return $e.textContent="No valid simulation cycles could be run with the provided inputs.",$e.classList.remove("hidden"),void Le.classList.add("hidden");const h=function(e,t){const n=e.filter((e=>e>0)).length/e.length*100;e.sort(((e,t)=>e-t));const a=e[Math.floor(e.length/2)],o=e[Math.floor(.1*e.length)],s=e[Math.floor(.9*e.length)];t.sort(((e,t)=>e-t));const r=t.length>0?t[Math.floor(t.length/2)]:0;return{successRate:n,medianValue:a,p10Value:o,p90Value:s,medianFlexYears:r}}(g,y);c={...h,...t,allPaths:m},function(t){const{successRate:n,medianValue:a,p10Value:o,p90Value:s,medianFlexYears:r,currency:l}=t;Me.textContent=`${n.toFixed(1)}%`,Ae.textContent=e(a,l),we.textContent=e(o,l),Ce.textContent=e(s,l),Se.textContent=`${r} yrs`,Be.classList.remove("hidden"),Le.classList.add("hidden")}(c),function(t,n,a){if(Fe.innerHTML="",!t||0===t.length)return;const o=Fe.getBoundingClientRect(),s=o.width>0?o.width:600,r={top:50,right:130,bottom:50,left:80},l=s-r.left-r.right,i=400-r.top-r.bottom;if(l<=0)return;const d=d3.select("#simulationPlotContainer").append("svg").attr("width",l+r.left+r.right).attr("height",i+r.top+r.bottom).append("g").attr("transform",`translate(${r.left},${r.top})`),c=d3.select("body").append("div").attr("class","d3-tooltip"),u=[],m=[],g=[];for(let e=0;e<=n;e++)if(t.every((t=>t&&t[e]))){const n=t.map((t=>t[e].value)).sort(((e,t)=>e-t));u.push({age:a+e,value:n[Math.floor(.1*n.length)]}),m.push({age:a+e,value:n[Math.floor(.5*n.length)]}),g.push({age:a+e,value:n[Math.floor(.9*n.length)]})}const y=[{path:u,color:"#ef4444",label:"10th Percentile"},{path:m,color:"#3b82f6",label:"Median (50th)"},{path:g,color:"#22c55e",label:"90th Percentile"}],h=d3.max(g,(e=>e.value))||fe.value,p=d3.scaleLinear().domain([a,a+n]).range([0,l]),v=d3.scaleLinear().domain([0,h]).range([i,0]).nice();d.append("g").attr("class","grid").attr("transform",`translate(0,${i})`).call(d3.axisBottom(p).ticks(10).tickSize(-i).tickFormat("")),d.append("g").attr("class","grid").call(d3.axisLeft(v).ticks(5).tickSize(-l).tickFormat("")),d.append("g").attr("class","axis").attr("transform",`translate(0,${i})`).call(d3.axisBottom(p).tickFormat(d3.format("d"))),d.append("g").attr("class","axis").call(d3.axisLeft(v).ticks(5).tickFormat((e=>isNaN(e)?"":0===e?"0":Math.abs(e)>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":Math.abs(e)>=1e3?(e/1e3).toFixed(0)+"k":e.toString()))),d.append("text").attr("text-anchor","middle").attr("x",l/2).attr("y",i+r.bottom-10).text("Age").attr("class","axis-label"),d.append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("y",0-r.left+20).attr("x",0-i/2).text("Portfolio Value (Real Dollars)").attr("class","axis-label"),d.append("text").attr("x",l/2).attr("y",0-r.top/2).attr("class","plot-title").text(`Distribution of ${t.length.toLocaleString()} Retirement Outcomes`);const f=d3.line().x((e=>p(e.age))).y((e=>v(e.value)));t.forEach((e=>{d.append("path").datum(e).attr("class","sim-path").style("stroke","#a5b4fc").attr("d",f)})),y.forEach(((e,t)=>{if(e.path.length>0){d.append("path").datum(e.path).attr("class","percentile-line").style("stroke",e.color).attr("d",f);const n=d.append("g").attr("class","legend-item").attr("transform",`translate(${l+10}, ${20*t})`);n.append("rect").attr("width",10).attr("height",10).style("fill",e.color),n.append("text").attr("x",15).attr("y",9).text(e.label).style("font-size","0.75rem")}}));const b=d3.bisector((e=>e.age)).left;d.append("rect").attr("width",l).attr("height",i).style("fill","none").style("pointer-events","all").on("mouseover",(()=>c.style("opacity",1))).on("mouseout",(()=>c.style("opacity",0))).on("mousemove",(t=>{const[n]=d3.pointer(t),a=p.invert(n);let o=`<strong>Age: ${a.toFixed(1)}</strong><hr class="my-1 border-gray-400">`;y.forEach((t=>{if(t.path.length>0){const n=b(t.path,a,1),s=t.path[n-1],r=t.path[n],l=r&&a-s.age>r.age-a?r:s;l&&(o+=`<div style="color: ${t.color};">${t.label}: ${e(l.value,M.value)}</div>`)}})),c.html(o).style("left",t.pageX+15+"px").style("top",t.pageY-28+"px")}))}(c.allPaths,95-t.simRetirementAge,t.simRetirementAge)}),50))}function et(e,t,n,a,o,s,r){let l=t;const i=t,d=i*(1-s),c=[{age:n,value:l}],u=95-n;let m=0,g=!1;for(let t=0;t<u;t++){l*=1+((1+e(t))/(1+r)-1),s>0&&(l<d?g=!0:l>=i&&(g=!1));let u=a;g&&(u=o,m++),l-=u,l<0&&(l=0),c.push({age:n+t+1,value:l})}return{path:c,finalValue:l,flexYears:m}}function tt(){v.value="30",f.value="50000",b.value="70000",x.value="15000",E.value="40000",B.value="0",I.value="4",R.value="7",k.value="7",F.value="3",q.value="12";const e=document.getElementById("maxYearsMessage");[L,J,ye,se,$,e].forEach((e=>{e&&e.classList.add("hidden")})),fe.value="",xe.value="",be.value="",Ee.value="7",Ie.value="15",Re.value="1000",Pe.value="20",Ne.value="10",Ye.value="60",Ve.textContent="60",De.textContent="40",document.getElementById("simTypeHistorical").checked=!0,document.getElementById("simTypeMonteCarlo").checked=!1,pe.classList.add("hidden"),ve.classList.remove("hidden"),de&&(de.value=""),ce&&(ce.value=""),ue&&(ue.value=""),me&&(me.value=""),ge&&(ge.checked=!0),le&&(le.value="0"),ie&&(ie.value=(new Date).getFullYear()),C.classList.add("hidden"),S.classList.add("hidden"),d=null,c=null,i=null}function nt(){try{let t="FIRE Calculator Summary\n";t+="=======================\n\n";const n=M.value;t+="--- Main Inputs ---\n";const a=qe();for(const[e,n]of Object.entries(a))t+=`${e}: ${n}\n`;if(t+="\n",t+="--- Main Projection Results ---\n",d)for(const[e,n]of Object.entries(d))"annualProjectionData"!==e&&"monthlyProjectionData"!==e&&"earlyRetirementPlotData"!==e&&(t+=`${e}: ${"number"==typeof n?n.toFixed(2):n}\n`);if(t+="\n",i){const a=i;t+='--- "One More Year" Scenario ---\n',t+=`Extra Working Years: ${a.extraYears}\n`,t+=`New Portfolio Value: ${e(a.newPortfolioValue,n)}\n`,t+=`New Retirement Age: ${a.newRetirementAge.toFixed(1)}\n\n`}if(c){const a=c;t+=`--- Advanced Retirement Simulation (${"monteCarlo"===a.simType?"Monte Carlo":"Historical Cycles"}) ---\n`,t+=`Portfolio Simulated: ${e(a.simPortfolioValue,n)} at age ${a.simRetirementAge}\n`,"monteCarlo"===a.simType?t+=`Avg. Return: ${a.simReturn}%, Volatility (Std. Dev): ${a.simVolatility}%, Simulations: ${a.simCount}\n`:t+=`Stock/Bond Allocation: ${100*a.stockAllocation}% / ${100*(1-a.stockAllocation)}%\n`,t+=`Spending Flexibility: Reduce by ${100*a.flexReduction}% if portfolio drops ${100*a.flexThreshold}% below initial value.\n`,t+=`Success Rate: ${a.successRate.toFixed(1)}%\n`,t+=`Median Final Value (Age 95): ${e(a.medianValue,n)}\n`,t+=`10th Percentile Final Value (Age 95): ${e(a.p10Value,n)}\n`,t+=`90th Percentile Final Value (Age 95): ${e(a.p90Value,n)}\n`,t+=`Median Years with Reduced Spending: ${a.medianFlexYears} yrs\n\n`}Ue.value=t,Oe.classList.remove("hidden")}catch(e){console.error("Error generating export data:",e),alert("An error occurred while preparing the data for export.")}}function at(){Ue.select(),Ue.setSelectionRange(0,99999);try{document.execCommand("copy"),He.textContent="Copied!",setTimeout((()=>{He.textContent="Copy to Clipboard"}),2e3)}catch(e){console.error("Failed to copy text: ",e),alert("Failed to copy. Please select and copy manually.")}}p.textContent=(new Date).getFullYear(),function(){A&&A.addEventListener("click",Ge),w&&w.addEventListener("click",tt),Q&&Q.addEventListener("click",Je),ke&&ke.addEventListener("click",(()=>_e(null,!1))),C&&C.addEventListener("click",(()=>window.print())),S&&S.addEventListener("click",nt),je&&je.addEventListener("click",(()=>Oe.classList.add("hidden"))),He&&He.addEventListener("click",at),ge&&ge.addEventListener("click",Xe);const e=document.getElementById("annualPreFireTabButton"),n=document.getElementById("monthlyPreFireTabButton"),a=document.getElementById("postFireTabButton");e&&e.addEventListener("click",(()=>t("annualPreFire"))),n&&n.addEventListener("click",(()=>t("monthlyPreFire"))),a&&a.addEventListener("click",(()=>t("postFire"))),Te.forEach((e=>{e.addEventListener("click",(()=>{Ee.value=e.dataset.return,Ie.value=e.dataset.vol}))})),he.forEach((e=>{e.addEventListener("change",(()=>{const e=document.getElementById("simTypeMonteCarlo").checked;pe.classList.toggle("hidden",!e),ve.classList.toggle("hidden",e)}))})),Ye.addEventListener("input",(()=>{Ve.textContent=Ye.value,De.textContent=100-Ye.value}))}(),tt();const ot=document.getElementById("eventsList"),st=document.getElementById("addEventForm"),rt=document.getElementById("eventType"),lt=document.getElementById("eventDescription"),it=document.getElementById("eventAmount"),dt=document.getElementById("eventStartAge"),ct=document.getElementById("eventEndAge");function ut(){ot&&(0!==g.length?ot.innerHTML=g.map(((t,n)=>`\n        <div class="flex items-center gap-2 mb-1 p-2 bg-gray-50 rounded">\n            <span class="flex-shrink-0 px-2 py-1 rounded text-xs ${"income"===t.type?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}">${t.type.toUpperCase()}</span>\n            <span class="font-medium flex-grow">${t.description}</span>\n            <span class="flex-shrink-0">${e(t.amount,M.value)}/yr</span>                   <span class="flex-shrink-0 text-gray-600">Age ${t.startAge}${t.endAge&&t.endAge!==t.startAge?"–"+t.endAge:""}</span>\n            <button class="ml-2 text-sm text-gray-400 hover:text-red-500" onclick="removeEvent(${n})">✕</button>\n        </div>\n    `)).join(""):ot.innerHTML='<p class="text-gray-500">No events added yet.</p>')}window.removeEvent=function(e){g.splice(e,1),ut()},st&&st.addEventListener("submit",(function(e){e.preventDefault();const t=rt.value,n=lt.value.trim(),a=parseFloat(it.value),o=parseFloat(dt.value),s=ct.value?parseFloat(ct.value):o;!n||isNaN(a)||isNaN(o)||(g.push({type:t,description:n,amount:a,startAge:o,endAge:s}),lt.value="",it.value="",dt.value="",ct.value="",ut())})),ut(),We&&We.addEventListener("change",(function(){yt(),Ge()}));const mt="coastBaristaOptions";let gt=document.getElementById(mt);if(!gt){gt=document.createElement("div"),gt.id=mt,gt.className="mb-4 non-printable";const e=document.getElementById("eventsTimelineSection");e&&e.insertAdjacentElement("afterend",gt)}function yt(){let e="";"coast"===We.value&&(e='<div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">\n            <h4 class="font-semibold text-blue-800">Coast FIRE Options</h4>\n            <p class="text-sm text-gray-600 mt-2 mb-3">\n                <b>Coast FIRE Explained:</b> This is the point where you have enough in your retirement accounts that, without contributing another penny, it will grow to support your full retirement by a traditional retirement age (e.g., 65). Once you hit your Coast FIRE number, you only need to earn enough to cover your current living expenses, freeing you from the need for high-stress, high-paying jobs.\n            </p>\n            <div class="flex gap-4 items-end mt-2">\n                <div>\n                    <label for="coastTargetAge" class="block font-medium text-gray-700">Target Retirement Age</label>\n                    <input type="number" id="coastTargetAge" value="65" min="40" max="80" step="1" class="border rounded px-2 py-1 mt-1" style="width:80px;">\n                </div>\n            </div>\n        </div>'),gt.innerHTML=e}yt();let ht=document.getElementById("sharePlanButton");ht||(ht=document.createElement("button"),ht.id="sharePlanButton",ht.className="ml-4 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md",ht.textContent="Share Plan",C.insertAdjacentElement("afterend",ht)),ht.addEventListener("click",(function(){const e=qe(),t=We.value;let n=new URLSearchParams;if(Object.entries(e).forEach((([e,t])=>n.set(e,t))),n.set("mode",t),"coast"===t){const e=document.getElementById("coastTargetAge");e&&e.value&&n.set("coastTargetAge",e.value)}Array.isArray(g)&&g.length>0&&n.set("events",encodeURIComponent(JSON.stringify(g))),n.set("whatIfSavings",pt.value),n.set("whatIfRetireExpenses",ft.value),n.set("whatIfMonthlyIncome",xt.value);const a=window.location.origin+window.location.pathname+"?"+n.toString();let o=document.getElementById("sharePlanModal");o||(o=document.createElement("div"),o.id="sharePlanModal",o.className="modal",o.innerHTML='<div class="modal-content"><span id="closeSharePlanModal" class="close-button">&times;</span><h3 class="text-xl font-semibold text-gray-800 mb-4">Share Your Plan</h3><p class="text-sm text-gray-600 mb-2">Copy this link to share your plan with others.</p><input id="sharePlanUrlInput" class="w-full border rounded p-2 mb-2 bg-gray-100" readonly><button id="copySharePlanUrlButton" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Copy Link</button></div>',document.body.appendChild(o)),document.getElementById("sharePlanUrlInput").value=a,o.style.display="flex",document.getElementById("closeSharePlanModal").onclick=()=>o.style.display="none",document.getElementById("copySharePlanUrlButton").onclick=()=>{const e=document.getElementById("sharePlanUrlInput");e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),document.getElementById("copySharePlanUrlButton").textContent="Copied!",setTimeout((()=>{document.getElementById("copySharePlanUrlButton").textContent="Copy Link"}),2e3)}})),function(){const e=new URLSearchParams(window.location.search);if(0===e.toString().length)return;let t=!1;if(["currentAge","currentSavings","grossAnnualIncome","yearlySavingsContribution","yearlyExpensesInRetirement","withdrawalRate","preFireReturn","postFireReturn","expectedInflationRate","monthlyIncomeAfterFIRE","numMonthlyRows","currency"].forEach((n=>{if(e.has(n)){const a=document.getElementById(n);a&&(a.value=e.get(n),t=!0)}})),e.has("mode")&&(We.value=e.get("mode"),yt(),t=!0),e.has("coastTargetAge")){const n=document.getElementById("coastTargetAge");n&&(n.value=e.get("coastTargetAge"),t=!0)}if(e.has("events"))try{const n=JSON.parse(decodeURIComponent(e.get("events")));Array.isArray(n)&&(g=n,ut(),t=!0)}catch(e){console.error("Error parsing events from URL",e)}if(e.has("whatIfSavings")){const n=document.getElementById("whatIfSavings");if(n){const a=parseFloat(e.get("whatIfSavings"));n.max=Math.max(n.max||0,1.2*a),n.value=a,t=!0}}if(e.has("whatIfRetireExpenses")){const n=document.getElementById("whatIfRetireExpenses");if(n){const a=parseFloat(e.get("whatIfRetireExpenses"));n.max=Math.max(n.max||0,1.2*a),n.value=a,t=!0}}if(e.has("whatIfMonthlyIncome")){const n=document.getElementById("whatIfMonthlyIncome");if(n){const a=parseFloat(e.get("whatIfMonthlyIncome"));n.max=Math.max(n.max||0,1.2*a),n.value=a,t=!0}}t&&setTimeout((()=>{kt(),Ft(),Ge()}),250)}();document.getElementById("whatIfLeversSection");const pt=document.getElementById("whatIfSavings"),vt=document.getElementById("whatIfSavingsValue"),ft=document.getElementById("whatIfRetireExpenses"),bt=document.getElementById("whatIfRetireExpensesValue"),xt=document.getElementById("whatIfMonthlyIncome"),Et=document.getElementById("whatIfMonthlyIncomeValue"),It=document.getElementById("whatIfResultLabel"),Rt=document.getElementById("whatIfResultValue");function kt(){const e=qe();pt.min=0,pt.max=Math.max(1e3,2*e.yearlySavingsContribution,1.2*parseFloat(pt.value)||0),vt.textContent=e.yearlySavingsContribution,pt.value=e.yearlySavingsContribution,ft.min=Math.max(1e3,e.yearlyExpensesInRetirement/2),ft.max=Math.max(1e4,2*e.yearlyExpensesInRetirement,1.2*parseFloat(ft.value)||0),bt.textContent=e.yearlyExpensesInRetirement,ft.value=e.yearlyExpensesInRetirement,xt.min=0,xt.max=Math.max(2e3,2*e.monthlyIncomeAfterFIRE,1.2*parseFloat(xt.value)||0),Et.textContent=e.monthlyIncomeAfterFIRE,Et.value=e.monthlyIncomeAfterFIRE}function Ft(){let e=n({...qe(),yearlySavingsContribution:parseFloat(pt.value),yearlyExpensesInRetirement:parseFloat(ft.value),monthlyIncomeAfterFIRE:parseFloat(xt.value)},g);if(!e.error&&e)if("coast"===e.mode&&e.coastFIREAge)It.textContent="Projected Coast Age",Rt.textContent=e.coastFIREAge.toFixed(1);else if(e.fireReached){It.textContent="Projected Time to FIRE";const t=Math.floor(e.timeToFIREMonths/12),n=e.timeToFIREMonths%12;Rt.textContent=`${t} yrs, ${n} mos`}else It.textContent="Projected Time to FIRE",Rt.textContent="> 70 Yrs";else Rt.textContent="--"}[pt,ft,xt].forEach((e=>{e.addEventListener("input",(function(){e===pt&&(vt.textContent=parseInt(e.value).toLocaleString()),e===ft&&(bt.textContent=parseInt(e.value).toLocaleString()),e===xt&&(Et.textContent=parseInt(e.value).toLocaleString()),Ft()}))})),A.addEventListener("click",(()=>{setTimeout((()=>{kt(),Ft()}),150)}));